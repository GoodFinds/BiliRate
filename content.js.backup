'use strict';

// Bç«™ä¸‰è¿ç‡è®¡ç®—å™¨ - Chromeæ‰©å±•ç‰ˆ
(function() {
    let panelVisible = true;
    let lastUpdateTime = 0;
    let updateInterval;
    
    // è§£æåŒ…å«å•ä½çš„æ•°å­—ï¼ˆä¸‡ã€äº¿ç­‰ï¼‰
    function parseNumberWithUnit(text) {
        if (!text || typeof text !== 'string') return 0;
        
        text = text.trim();
        
        // å¤„ç†äº¿çº§æ•°å­—
        if (text.includes('äº¿')) {
            return parseFloat(text.replace('äº¿', '')) * 100000000;
        }
        
        // å¤„ç†ä¸‡çº§æ•°å­—
        if (text.includes('ä¸‡')) {
            return parseFloat(text.replace('ä¸‡', '')) * 10000;
        }
        
        // ç›´æ¥è½¬æ¢æ•°å­—
        return parseFloat(text) || 0;
    }
    
    // å°è¯•å¤šç§æ–¹å¼è·å–è¯„è®ºæ•°
    function getCommentsCount() {
        try {
            // æ–¹æ³•1: é€šè¿‡shadowRootè·å–
            const commentElement = document.querySelector("#commentapp > bili-comments")
                ?.shadowRoot?.querySelector("#header > bili-comments-header-renderer")
                ?.shadowRoot?.querySelector("#count");
                
            if (commentElement) {
                return parseNumberWithUnit(commentElement.textContent);
            }
            
            // æ–¹æ³•2: å°è¯•è·å–å¸¸è§„DOMå…ƒç´ 
            const regularCommentCount = document.querySelector('.total-reply') || 
                                     document.querySelector('.comment-total');
            if (regularCommentCount) {
                return parseNumberWithUnit(regularCommentCount.textContent);
            }
            
            // æ–¹æ³•3: é¡µé¢æ–‡æœ¬æœç´¢ï¼ˆä¸å¤ªå¯é ä½†ä½œä¸ºåå¤‡ï¼‰
            const pageText = document.body.innerText;
            const commentMatch = pageText.match(/è¯„è®º\s*(\d+[\.\d]*[ä¸‡äº¿]?)/);
            if (commentMatch && commentMatch[1]) {
                return parseNumberWithUnit(commentMatch[1]);
            }
        } catch (error) {
            console.log("è·å–è¯„è®ºæ•°é‡å¤±è´¥:", error);
        }
        
        return -1; // è·å–å¤±è´¥
    }
    
    // å®‰å…¨åœ°è·å–å…ƒç´ æ–‡æœ¬
    function getElementText(selector) {
        const element = document.querySelector(selector);
        return element ? element.textContent.trim() : '';
    }
    
    // è®¡ç®—ä¸‰è¿ç‡å¹¶æ˜¾ç¤º
    function calculateTripleRate() {
        try {
            // æ£€æŸ¥æ˜¯å¦åœ¨é¡µé¢æ›´æ–°æœŸé—´ï¼ˆé˜²æ­¢é¢‘ç¹è®¡ç®—ï¼‰
            const currentTime = Date.now();
            if (currentTime - lastUpdateTime < 500) return;
            lastUpdateTime = currentTime;
            
            // è·å–äº’åŠ¨æ•°æ®
            const likesText = getElementText('.video-like-info.video-toolbar-item-text') || 
                              getElementText('.like span') ||
                              getElementText('.like-info');
                              
            const coinsText = getElementText('.video-coin-info.video-toolbar-item-text') ||
                              getElementText('.coin span') ||
                              getElementText('.coin-info');
                              
            const favoritesText = getElementText('.video-fav-info.video-toolbar-item-text') ||
                                 getElementText('.collect span') ||
                                 getElementText('.collect-info');
                                 
            const viewText = getElementText('.view-text') ||
                            getElementText('.view-count') ||
                            getElementText('.play-text') ||
                            getElementText('.view span');
            
            const likes = parseNumberWithUnit(likesText);
            const coins = parseNumberWithUnit(coinsText);
            const favorites = parseNumberWithUnit(favoritesText);
            const views = parseNumberWithUnit(viewText);
            const commentsCount = getCommentsCount();
            
            // è§†é¢‘æ•°æ®ä¸å®Œæ•´ï¼Œæš‚ä¸è®¡ç®—
            if (!views) {
                console.log("æ’­æ”¾é‡æ•°æ®æ— æ³•è·å–ï¼Œç¨åé‡è¯•");
                return;
            }
            
            // è®¡ç®—ä¸‰è¿ç‡
            const tripleRate = ((likes + coins + favorites) / (views) * 100).toFixed(2);
            
            // è®¡ç®—äº’åŠ¨ç‡ï¼ˆè¯„è®ºæ•°/æ’­æ”¾é‡ï¼‰
            const interactionRate = commentsCount > 0 ? ((commentsCount / views) * 100).toFixed(2) : "æ— æ³•è®¡ç®—";
            
            // è®¡ç®—è¯„åˆ†ç­‰çº§
            let rating = "ä¸€èˆ¬";
            let color = "#333333";
            
            if (tripleRate > 30) {
                rating = "çˆ†æ¬¾";
                color = "#FF0000";
            } else if (tripleRate > 20) {
                rating = "ç ´åœˆ";
                color = "#FF6600";
            } else if (tripleRate > 15) {
                rating = "å¾ˆå¥½";
                color = "#8A2BE2";
            } else if (tripleRate > 10) {
                rating = "è¿˜ä¸é”™";
                color = "#0099FF";
            } else if (tripleRate < 5) {
                rating = "è¾ƒå·®";
                color = "#999999";
            }
            
            updateOrCreatePanel({
                likes,
                coins,
                favorites, 
                views,
                commentsCount,
                tripleRate,
                interactionRate,
                rating,
                color
            });
        } catch (error) {
            console.error("è®¡ç®—ä¸‰è¿ç‡æ—¶å‡ºé”™:", error);
        }
    }
    
    // åˆ›å»ºæˆ–æ›´æ–°æ˜¾ç¤ºé¢æ¿
    function updateOrCreatePanel(data) {
        let panel = document.getElementById('bili-triple-rate-panel');
        
        if (!panel) {
            // åˆ›å»ºä¸»é¢æ¿
            panel = document.createElement('div');
            panel.id = 'bili-triple-rate-panel';
            panel.style.cssText = `
                position: fixed;
                top: 180px;
                right: 20px;
                background-color: rgba(255, 255, 255, 0.95);
                padding: 12px;
                border-radius: 6px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.15);
                z-index: 9999;
                font-size: 14px;
                transition: all 0.3s ease;
                border: 1px solid #eee;
                max-width: 220px;
                font-family: "Microsoft YaHei", sans-serif;
            `;
            
            // åˆ›å»ºæ ‡é¢˜æ 
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                padding-bottom: 8px;
                border-bottom: 1px solid #eee;
            `;
            
            const title = document.createElement('div');
            title.textContent = 'Bç«™ä¸‰è¿ç‡åˆ†æ';
            title.style.fontWeight = 'bold';
            title.style.color = '#fb7299'; // Bç«™ç²‰è‰²
            
            // æ·»åŠ æŠ˜å /å±•å¼€æŒ‰é’®
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = 'â€”';
            toggleBtn.style.cssText = `
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
            `;
            toggleBtn.addEventListener('click', togglePanel);
            
            header.appendChild(title);
            header.appendChild(toggleBtn);
            panel.appendChild(header);
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const content = document.createElement('div');
            content.id = 'bili-triple-rate-content';
            panel.appendChild(content);
            
            document.body.appendChild(panel);
        }
        
        // æ›´æ–°å†…å®¹
        const content = document.getElementById('bili-triple-rate-content');
        if (content) {
            content.innerHTML = `
                <div style="color: #333;">
                    <div style="margin-bottom: 10px;">
                        <span style="font-weight: bold; color: ${data.color};">â­ è¯„çº§: ${data.rating}</span>
                        <span style="float: right; font-weight: bold;">ğŸ“Š ${data.tripleRate}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ğŸ‘ ç‚¹èµ:</span>
                        <span>${formatNumber(data.likes)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ğŸ’° æŠ•å¸:</span>
                        <span>${formatNumber(data.coins)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>â­ æ”¶è—:</span>
                        <span>${formatNumber(data.favorites)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ğŸ‘€ æ’­æ”¾:</span>
                        <span>${formatNumber(data.views)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ğŸ’¬ è¯„è®º:</span>
                        <span>${data.commentsCount === -1 ? 'åŠ è½½ä¸­' : formatNumber(data.commentsCount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>ğŸ’¡ äº’åŠ¨ç‡:</span>
                        <span>${data.interactionRate === "æ— æ³•è®¡ç®—" ? data.interactionRate : data.interactionRate + "%"}</span>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: #999; text-align: center;">
                        Bç«™ä¸‰è¿ç‡è®¡ç®—å™¨ v1.0.1
                    </div>
                </div>
            `;
        }
    }
    
    // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
    function formatNumber(num) {
        if (num === -1) return 'åŠ è½½ä¸­';
        if (num === 0) return '0';
        
        if (num >= 100000000) {
            return (num / 100000000).toFixed(1) + 'äº¿';
        }
        
        if (num >= 10000) {
            return (num / 10000).toFixed(1) + 'ä¸‡';
        }
        
        return num.toLocaleString();
    }
    
    // åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
    function togglePanel() {
        const panel = document.getElementById('bili-triple-rate-panel');
        const content = document.getElementById('bili-triple-rate-content');
        const toggleBtn = panel.querySelector('button');
        
        if (panelVisible) {
            content.style.display = 'none';
            toggleBtn.textContent = '+';
            panel.style.padding = '8px 12px';
        } else {
            content.style.display = 'block';
            toggleBtn.textContent = 'â€”';
            panel.style.padding = '12px';
        }
        
        panelVisible = !panelVisible;
        
        // ä¿å­˜ç”¨æˆ·è®¾ç½®
        chrome.storage.local.set({ 'panelVisible': panelVisible });
    }
    
    // åˆå§‹åŒ–å‡½æ•°
    function initialize() {
        // ä»å­˜å‚¨ä¸­æ¢å¤è®¾ç½®
        chrome.storage.local.get('panelVisible', function(result) {
            if (result.hasOwnProperty('panelVisible')) {
                panelVisible = result.panelVisible;
                
                // å¦‚æœè®¾ç½®ä¸ºéšè—ï¼Œåœ¨åˆå§‹åŒ–ååº”ç”¨
                if (!panelVisible) {
                    setTimeout(() => {
                        const content = document.getElementById('bili-triple-rate-content');
                        const panel = document.getElementById('bili-triple-rate-panel');
                        const toggleBtn = panel?.querySelector('button');
                        
                        if (content) content.style.display = 'none';
                        if (toggleBtn) toggleBtn.textContent = '+';
                        if (panel) panel.style.padding = '8px 12px';
                    }, 1000);
                }
            }
        });
        
        // æ·»åŠ ä¸€ä¸ªå»¶è¿Ÿï¼Œç¡®ä¿é¡µé¢å…ƒç´ åŠ è½½å®Œæˆ
        setTimeout(() => {
            calculateTripleRate();
            
            // æ¯3ç§’æ›´æ–°ä¸€æ¬¡
            updateInterval = setInterval(calculateTripleRate, 3000);
            
            // ç›‘å¬URLå˜åŒ–ï¼ˆBç«™å•é¡µåº”ç”¨ï¼‰
            let lastUrl = location.href;
            const urlObserver = new MutationObserver(() => {
                if (location.href !== lastUrl) {
                    lastUrl = location.href;
                    
                    // æ¸…é™¤æ—§çš„é¢æ¿å’Œå®šæ—¶å™¨
                    const oldPanel = document.getElementById('bili-triple-rate-panel');
                    if (oldPanel) oldPanel.remove();
                    
                    clearInterval(updateInterval);
                    
                    // é‡æ–°åˆå§‹åŒ–
                    setTimeout(() => {
                        calculateTripleRate();
                        updateInterval = setInterval(calculateTripleRate, 3000);
                    }, 1500);
                }
            });
            
            urlObserver.observe(document, { subtree: true, childList: true });
            
        }, 2000);
    }
    
    // å¯åŠ¨æ‰©å±•
    initialize();
})();