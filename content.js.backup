'use strict';

// B站三连率计算器 - Chrome扩展版
(function() {
    let panelVisible = true;
    let lastUpdateTime = 0;
    let updateInterval;
    
    // 解析包含单位的数字（万、亿等）
    function parseNumberWithUnit(text) {
        if (!text || typeof text !== 'string') return 0;
        
        text = text.trim();
        
        // 处理亿级数字
        if (text.includes('亿')) {
            return parseFloat(text.replace('亿', '')) * 100000000;
        }
        
        // 处理万级数字
        if (text.includes('万')) {
            return parseFloat(text.replace('万', '')) * 10000;
        }
        
        // 直接转换数字
        return parseFloat(text) || 0;
    }
    
    // 尝试多种方式获取评论数
    function getCommentsCount() {
        try {
            // 方法1: 通过shadowRoot获取
            const commentElement = document.querySelector("#commentapp > bili-comments")
                ?.shadowRoot?.querySelector("#header > bili-comments-header-renderer")
                ?.shadowRoot?.querySelector("#count");
                
            if (commentElement) {
                return parseNumberWithUnit(commentElement.textContent);
            }
            
            // 方法2: 尝试获取常规DOM元素
            const regularCommentCount = document.querySelector('.total-reply') || 
                                     document.querySelector('.comment-total');
            if (regularCommentCount) {
                return parseNumberWithUnit(regularCommentCount.textContent);
            }
            
            // 方法3: 页面文本搜索（不太可靠但作为后备）
            const pageText = document.body.innerText;
            const commentMatch = pageText.match(/评论\s*(\d+[\.\d]*[万亿]?)/);
            if (commentMatch && commentMatch[1]) {
                return parseNumberWithUnit(commentMatch[1]);
            }
        } catch (error) {
            console.log("获取评论数量失败:", error);
        }
        
        return -1; // 获取失败
    }
    
    // 安全地获取元素文本
    function getElementText(selector) {
        const element = document.querySelector(selector);
        return element ? element.textContent.trim() : '';
    }
    
    // 计算三连率并显示
    function calculateTripleRate() {
        try {
            // 检查是否在页面更新期间（防止频繁计算）
            const currentTime = Date.now();
            if (currentTime - lastUpdateTime < 500) return;
            lastUpdateTime = currentTime;
            
            // 获取互动数据
            const likesText = getElementText('.video-like-info.video-toolbar-item-text') || 
                              getElementText('.like span') ||
                              getElementText('.like-info');
                              
            const coinsText = getElementText('.video-coin-info.video-toolbar-item-text') ||
                              getElementText('.coin span') ||
                              getElementText('.coin-info');
                              
            const favoritesText = getElementText('.video-fav-info.video-toolbar-item-text') ||
                                 getElementText('.collect span') ||
                                 getElementText('.collect-info');
                                 
            const viewText = getElementText('.view-text') ||
                            getElementText('.view-count') ||
                            getElementText('.play-text') ||
                            getElementText('.view span');
            
            const likes = parseNumberWithUnit(likesText);
            const coins = parseNumberWithUnit(coinsText);
            const favorites = parseNumberWithUnit(favoritesText);
            const views = parseNumberWithUnit(viewText);
            const commentsCount = getCommentsCount();
            
            // 视频数据不完整，暂不计算
            if (!views) {
                console.log("播放量数据无法获取，稍后重试");
                return;
            }
            
            // 计算三连率
            const tripleRate = ((likes + coins + favorites) / (views) * 100).toFixed(2);
            
            // 计算互动率（评论数/播放量）
            const interactionRate = commentsCount > 0 ? ((commentsCount / views) * 100).toFixed(2) : "无法计算";
            
            // 计算评分等级
            let rating = "一般";
            let color = "#333333";
            
            if (tripleRate > 30) {
                rating = "爆款";
                color = "#FF0000";
            } else if (tripleRate > 20) {
                rating = "破圈";
                color = "#FF6600";
            } else if (tripleRate > 15) {
                rating = "很好";
                color = "#8A2BE2";
            } else if (tripleRate > 10) {
                rating = "还不错";
                color = "#0099FF";
            } else if (tripleRate < 5) {
                rating = "较差";
                color = "#999999";
            }
            
            updateOrCreatePanel({
                likes,
                coins,
                favorites, 
                views,
                commentsCount,
                tripleRate,
                interactionRate,
                rating,
                color
            });
        } catch (error) {
            console.error("计算三连率时出错:", error);
        }
    }
    
    // 创建或更新显示面板
    function updateOrCreatePanel(data) {
        let panel = document.getElementById('bili-triple-rate-panel');
        
        if (!panel) {
            // 创建主面板
            panel = document.createElement('div');
            panel.id = 'bili-triple-rate-panel';
            panel.style.cssText = `
                position: fixed;
                top: 180px;
                right: 20px;
                background-color: rgba(255, 255, 255, 0.95);
                padding: 12px;
                border-radius: 6px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.15);
                z-index: 9999;
                font-size: 14px;
                transition: all 0.3s ease;
                border: 1px solid #eee;
                max-width: 220px;
                font-family: "Microsoft YaHei", sans-serif;
            `;
            
            // 创建标题栏
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                padding-bottom: 8px;
                border-bottom: 1px solid #eee;
            `;
            
            const title = document.createElement('div');
            title.textContent = 'B站三连率分析';
            title.style.fontWeight = 'bold';
            title.style.color = '#fb7299'; // B站粉色
            
            // 添加折叠/展开按钮
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = '—';
            toggleBtn.style.cssText = `
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
            `;
            toggleBtn.addEventListener('click', togglePanel);
            
            header.appendChild(title);
            header.appendChild(toggleBtn);
            panel.appendChild(header);
            
            // 创建内容容器
            const content = document.createElement('div');
            content.id = 'bili-triple-rate-content';
            panel.appendChild(content);
            
            document.body.appendChild(panel);
        }
        
        // 更新内容
        const content = document.getElementById('bili-triple-rate-content');
        if (content) {
            content.innerHTML = `
                <div style="color: #333;">
                    <div style="margin-bottom: 10px;">
                        <span style="font-weight: bold; color: ${data.color};">⭐ 评级: ${data.rating}</span>
                        <span style="float: right; font-weight: bold;">📊 ${data.tripleRate}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>👍 点赞:</span>
                        <span>${formatNumber(data.likes)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>💰 投币:</span>
                        <span>${formatNumber(data.coins)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>⭐ 收藏:</span>
                        <span>${formatNumber(data.favorites)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>👀 播放:</span>
                        <span>${formatNumber(data.views)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>💬 评论:</span>
                        <span>${data.commentsCount === -1 ? '加载中' : formatNumber(data.commentsCount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>💡 互动率:</span>
                        <span>${data.interactionRate === "无法计算" ? data.interactionRate : data.interactionRate + "%"}</span>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: #999; text-align: center;">
                        B站三连率计算器 v1.0.1
                    </div>
                </div>
            `;
        }
    }
    
    // 格式化数字显示
    function formatNumber(num) {
        if (num === -1) return '加载中';
        if (num === 0) return '0';
        
        if (num >= 100000000) {
            return (num / 100000000).toFixed(1) + '亿';
        }
        
        if (num >= 10000) {
            return (num / 10000).toFixed(1) + '万';
        }
        
        return num.toLocaleString();
    }
    
    // 切换面板显示/隐藏
    function togglePanel() {
        const panel = document.getElementById('bili-triple-rate-panel');
        const content = document.getElementById('bili-triple-rate-content');
        const toggleBtn = panel.querySelector('button');
        
        if (panelVisible) {
            content.style.display = 'none';
            toggleBtn.textContent = '+';
            panel.style.padding = '8px 12px';
        } else {
            content.style.display = 'block';
            toggleBtn.textContent = '—';
            panel.style.padding = '12px';
        }
        
        panelVisible = !panelVisible;
        
        // 保存用户设置
        chrome.storage.local.set({ 'panelVisible': panelVisible });
    }
    
    // 初始化函数
    function initialize() {
        // 从存储中恢复设置
        chrome.storage.local.get('panelVisible', function(result) {
            if (result.hasOwnProperty('panelVisible')) {
                panelVisible = result.panelVisible;
                
                // 如果设置为隐藏，在初始化后应用
                if (!panelVisible) {
                    setTimeout(() => {
                        const content = document.getElementById('bili-triple-rate-content');
                        const panel = document.getElementById('bili-triple-rate-panel');
                        const toggleBtn = panel?.querySelector('button');
                        
                        if (content) content.style.display = 'none';
                        if (toggleBtn) toggleBtn.textContent = '+';
                        if (panel) panel.style.padding = '8px 12px';
                    }, 1000);
                }
            }
        });
        
        // 添加一个延迟，确保页面元素加载完成
        setTimeout(() => {
            calculateTripleRate();
            
            // 每3秒更新一次
            updateInterval = setInterval(calculateTripleRate, 3000);
            
            // 监听URL变化（B站单页应用）
            let lastUrl = location.href;
            const urlObserver = new MutationObserver(() => {
                if (location.href !== lastUrl) {
                    lastUrl = location.href;
                    
                    // 清除旧的面板和定时器
                    const oldPanel = document.getElementById('bili-triple-rate-panel');
                    if (oldPanel) oldPanel.remove();
                    
                    clearInterval(updateInterval);
                    
                    // 重新初始化
                    setTimeout(() => {
                        calculateTripleRate();
                        updateInterval = setInterval(calculateTripleRate, 3000);
                    }, 1500);
                }
            });
            
            urlObserver.observe(document, { subtree: true, childList: true });
            
        }, 2000);
    }
    
    // 启动扩展
    initialize();
})();